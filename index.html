<!DOCTYPE html>
<html lang="es-CO">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confirmación de Asistencia</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="imagen"> 
        <img src="ELIANA_SEBASTIAN.png" alt="Encabezado">
    </div>

    <div class="contenido">
        <h1>¡Nos encantaría contar contigo!</h1>
        <p>Para confirmar tu asistencia, ingresa tus datos y encontraremos tu invitación. Si tu invitación incluye acompañantes, podrás confirmar la asistencia de todos ellos. Será un verdadero placer celebrar juntos este día tan especial.</p>
    </div>

    <div class="formulario">
        <!-- Formulario configurado para Formspree -->
        <form id="formulario" action="https://formspree.io/f/xzdpdbgk" method="POST">
            <label for="celular">Por favor, ingresa tu número de celular</label>
            <input 
                type="tel"
                id="celular"
                name="celular"
                placeholder="Ejemplo: 3113386910"
                required
            >
            <button type="submit">Buscar invitación</button>
        </form>

        <div id="resultado"></div>
    </div>

    <script>
        // URL del archivo CSV de Google Sheets (actualiza con tu URL real)
        const spreadsheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0AtXlzIWAgY5cIyOv9O2yXF5yBzuQlmcSASBzsCZ6jQ98Pljwsrb8ZSv2_nKp8luJUD_heGlfgZ_6/pub?gid=0&single=true&output=csv';

        // Función para obtener los datos del CSV
        function obtenerDatos() {
            return fetch(spreadsheetUrl)
                .then(response => response.text())
                .then(csv => parseCSV(csv))
                .catch(error => console.error('Error al obtener los datos:', error));
        }

        // Función para convertir el CSV a formato JSON
        function parseCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            const data = lines.slice(1).map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header.trim()] = values[index].trim();
                });
                return obj;
            });
            return data;
        }

        // Función para buscar la invitación
        function buscarInvitacion() {
            const celular = document.getElementById('celular').value.trim(); // Obtener número de celular

            if (!celular) {
                document.getElementById('resultado').innerHTML = '<p>Por favor, ingresa tu número de celular.</p>';
                return;
            }

            obtenerDatos().then(datos => {
                const invitacion = datos.find(dato => dato.TELEFONO === celular); // Buscar la invitación por celular
                if (invitacion) {
                    const grupo = invitacion.GRUPO; // Obtener el grupo
                    const personasEnGrupo = datos.filter(dato => dato.GRUPO === grupo); // Filtrar personas en el mismo grupo

                    mostrarFormularioConfirmacion(invitacion, personasEnGrupo);  // Mostrar el formulario de confirmación
                } else {
                    document.getElementById('resultado').innerHTML = '<p>No se encontró ninguna invitación con ese número de celular.</p>';
                }
            });
        }

        // Función para mostrar las preguntas de confirmación con checkboxes
        function mostrarFormularioConfirmacion(invitacion, personasEnGrupo) {
            let resultadoHTML = `<p class="cantidad-invitados"><strong>Cantidad de invitados:</strong> <span class="cantidad-numero">${personasEnGrupo.length}</span></p>`;
            resultadoHTML += '<form id="confirmacionForm">';
            resultadoHTML += '<p class="pregunta-seleccion-personas">Selecciona las personas por las que quieres responder:</p>';  <!-- Cambio aquí -->

            // Mostrar los checkboxes para cada persona del grupo
            personasEnGrupo.forEach(persona => {
                resultadoHTML += `
                    <div class="persona-item">
                        <div class="checkbox-container">
                            <input type="checkbox" id="persona-${persona.TELEFONO}" name="personas" value="${persona.NOMBRE} ${persona.APELLIDO}">
                        </div>
                        <div class="nombre-container">
                            <label for="persona-${persona.TELEFONO}">${persona.NOMBRE} ${persona.APELLIDO}</label>
                        </div>
                    </div>
                `;
            });

            // Añadir pregunta de confirmación (¿Asistirás?)
            resultadoHTML += `
                <p class="pregunta-asistencia">¿Asistirás a nuestra boda?</p>
                <div class="botones-asistencia">
                    <label>
                        <input type="radio" id="asistencia_si" name="asistencia" value="Sí">
                        Sí
                    </label>
                    <label>
                        <input type="radio" id="asistencia_no" name="asistencia" value="No">
                        No
                    </label>
                </div>
                <button type="submit">Confirmar asistencia</button>
            `;
            resultadoHTML += '</form>';
            document.getElementById('resultado').innerHTML = resultadoHTML;

            // Manejar el formulario de confirmación de asistencia
            document.getElementById('confirmacionForm').addEventListener('submit', function(event) {
                event.preventDefault();  // Evitar recarga de la página
                enviarFormulario(personasEnGrupo);  // Llamar a la función para enviar la confirmación
            });
        }

        // Función para enviar la confirmación de asistencia a Formspree
        function enviarFormulario(personasEnGrupo) {
            const asistencia_si = document.getElementById('asistencia_si').checked ? "Sí" : "";
            const asistencia_no = document.getElementById('asistencia_no').checked ? "No" : "";
            const personasSeleccionadas = [];
            const checkboxs = document.querySelectorAll('input[name="personas"]:checked');

            // Crear el array de personas seleccionadas
            checkboxs.forEach(checkbox => {
                personasSeleccionadas.push(checkbox.value); // Obtener el nombre completo de la persona
            });

            // Enviar los datos a Formspree, una fila por cada persona seleccionada
            personasSeleccionadas.forEach(persona => {
                const formData = new FormData();
                formData.append('celular', document.getElementById('celular').value.trim());  // El celular de la persona
                formData.append('persona', persona);  // Nombre completo de la persona seleccionada
                formData.append('asistencia', asistencia_si || asistencia_no);  // Asistencia (Sí/No)

                // Enviar cada fila con los datos al servidor de Formspree
                fetch('https://formspree.io/f/xzdpdbgk', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al enviar la solicitud');
                    }

                    return response.json();
                })
                .then(data => {
                    if (asistencia_si) {
                        document.getElementById('resultado').innerHTML = `
                            <div style="text-align: center; padding: 20px; font-size: 24px;">
                                <p>¡Gracias por confirmar tu asistencia!</p>
                                <p>Nos alegra saber que contarás con nosotros en este día tan especial.</p>
                            </div>
                        `;
                    } else if (asistencia_no) {
                        document.getElementById('resultado').innerHTML = `
                            <div style="text-align: center; padding: 20px; font-size: 24px;">
                                <p>Gracias por tu respuesta.</p>
                                <p>Esperamos que puedas acompañarnos en otro momento.</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error al enviar el formulario:', error);
                    document.getElementById('resultado').innerHTML = `
                        <div style="color: red; text-align: center;">
                            <p>Gracias por tu respuesta.</p>
                        </div>
                    `;
                });
            });
        }

        // Para cuando el formulario de búsqueda se envíe
        document.getElementById('formulario').addEventListener('submit', function(event) {
            event.preventDefault();  // Evitar recarga de la página
            buscarInvitacion();      // Llamar a la función para buscar la invitación
        });
    </script>
</body>
</html>
